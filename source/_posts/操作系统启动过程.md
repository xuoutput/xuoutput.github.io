---
title: 操作系统启动过程
date: 2019-10-03 11:16:37
tags:
- os
categories: 
- os
comments: false
permalink: 
---

# 操作系统启动过程

先过一遍阮一峰的[计算机是如何启动的？](http://www.ruanyifeng.com/blog/2013/02/booting.html)
知道了BIOS，MBR，GRUB，kernel，init

## 总结

操作系统的启动分为两个阶段：引导boot和启动startup。引导阶段开始于打开电源开关，结束于内核初始化完成和 systemd 进程成功运行。启动阶段接管了剩余工作，直到操作系统进入可操作状态。

### 初级

知道了BIOS，MBR，GRUB，kernel，init各个阶段是什么

### 中级

知道了硬盘结构， MBR的结构。前446B干嘛的
知道了systemd 进程（其是老式 System V 系统的 init 程序的替代品）
runlevel在init后，怎么查看，在哪？

![red](red.png)

![centos7](centos7.png)
![centos72](centos72.png)

### 高级

1. 知道了硬盘结构，512B从哪里读出来，怎么读出来
2. GRUB2的几个阶段，在MBR中的是第一个阶段。1.5阶段的是磁道上哪里，然后因为代码大了， 可以用来读取文件系统。所以第二阶段的/boot可以读取并识别了，2阶段。在/boot/grub2/xx.conf是配置，这个是第二阶段
3. 在FFFF0H这种的加电后，x86系统怎么处理，20条地址先，数据线。然后实模式下是访问是真正的物理地址，而在保护模式下是虚拟地址。什么时候进入保护模式
4. 在登录前的3中方式登录的区别。
5. BIOS的POST是不在内存中运行的，不然怎么检测内存条有没有插好，CPU存不存在。检查完后有个中断的。
6. 中断从OS的发展来看是一个硬件的发展，不是软中断。

## BIOS

BIOS中包含两块

1. POST
   1. 硬件自检，检查CPU，内存，显卡，鼠标外设，所以这个不是加载到内存中的。固件。
2. 启动顺序
   1. 决定从软盘，CD-ROM，硬盘或网络启动。

UEFI

## MBR

从例如只检测到硬盘，然后动硬盘的第一个001扇区读取 512B的数据，这就是MBR。MBR是一定从硬盘读出后放入内存的。
控制权从BIOS到MBR
3部分结构，

1. 那第一部分的GRUB和装在/boot/下有什么区别。
2. 第二部分就是分区表
3. 第三部的是在BIOS中启动顺序用到的

> 硬盘中MBR上的GURB和/boot/下的grub区别

可以理解为是不同阶段的grub，MBR中的grub是第一阶段的引导程序。而不是完整的grub。
[linux的/boot和grub和MBR和boot sector是什么关系？666](https://www.zhihu.com/question/27652991)

## GRUB

用grub来决定进入那个内核，有1 1.5 2 三个阶段

---

从 BIOS POST => MBR => GRUB => kernel => init => runLevel

![linux.png](linux.png)

1. BIOS: POST and gives control the BOOT Device and loads MBR (在选择的设备比如硬盘的第一个扇区，512B的MBR)
2. MBR executes the Boot Load
3. Grub Menu List
4. Grub loads Kernel and Initrd
5. Initrd initial root filesystem
6. Kernel loads the actual root files
7. /sbin/init is executed
8. checks runlevel in /etc/inittab
9. runs all the files present in /etc
10. run /etc/rc.local


首先大致知道整个系统的启动过程，然后要知道细节，具体从哪个地址到哪个地址，CPU控制权哪个程序交个哪个程序。
直到登录。进入系统。

CPU读取到CS：IP的值是FFFF0H， 然后这个地址在内存中到末尾就16B，所以只有一个跳转指令。跳转到BIOS中
> X86系统20个地址总线 8或16个数据总线。
然后知道显卡也是有BIOS的了。
磁盘的第一个扇区的大小就是512B  MBR,最外面开始存。 “0”磁道检测器
加载到内存的7c00处，磁盘可不是固件。
BIOS 将启动磁盘中的第 1 个扇区（MBR 扇区，Master Boot Record）的 512 个字节的数据加载到物理内存地址为 0x7C00 ~ 0x7E00 的区域，然后程序就跳转到 0x7C00 处开始执行，至此，BIOS 就完成了所有的工作，将控制权转交到了 MBR 中的代码。

“盘面”、“磁道”、“柱面”和“扇区”的含义逐一进行介绍。

POST不放入内存，固件就在固件中执行，而从磁盘中读取的MBR就会放入内存中。

实模式和保护模式。 实模式下可以直接访问物理地址。在保护膜实现是访问虚拟地址。


疑问：通电后到底是从哪个地址开始（实模式下应该是直接找物理地址），
CS:IP 到地址FFFF:0000 还是F000：FFF0，或者还是直接到BIOS中了，
然后有一跳跳转地址的，这是跳转到BIOS中吧
POST后还有中断的吧

Grub的具体过程看Linux Boot Sequence  
/boot/grub2/grub.cfg


---

启动登录后boot log后是在/var/log/
dmesg命令也能给你登录信息

最后的runlevel是6个level
/etc/inittab
runlevel也是个命令，可以看当前是在哪
默认的在/etc/init/文件夹下的rc-sysinit.conf //ubuntu
start up script, sk开头的
就是那个rc.d 文件夹 在/etc/下， 里面有s和k开头的

## 内存

在实模式下内存访问，在保护模式下内存访问，
虚拟化技术下一个地址分为5短 9 9 9 9 12 来看
HVA(host vritual address) => HPA(host physical address) 通过HPT (host page table)
GVA => GPA 通过 GPT(ghost page table)
GPA => HPA 通过硬件 HPT,软件NPT (nest page table)

最后可以通过GVA 到 HPA 缓存一个TLB

## 参考

[计算机是如何启动的？666](http://www.ruanyifeng.com/blog/2013/02/booting.html)
[Linux 的启动流程](http://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html)
[Linux Boot Process](https://www.youtube.com/watch?v=ZtVpz5VWjAs)
[Understanding the Linux Boot Process - CompTIA Linux+, LPIC-1](https://www.youtube.com/watch?v=mHB0Z-HUauo)
[BIOS启动过程](https://github.com/chyyuu/ucore_os_docs/blob/master/lab1/lab1_3_1_bios_booting.md)
[Linux系统启动过程分析](https://www.cnblogs.com/bluestorm/p/5981435.html)
[BIOS执行位置的问题](https://blog.csdn.net/ywf861029/article/details/5800549)
[The BIOS/MBR Boot Process](https://neosmart.net/wiki/mbr-boot-process/)
[How BIOS Works 666](http://flint.cs.yale.edu/feng/cos/resources/BIOS/)
[深入解析硬盘结构 666](https://caibaoz.com/blog/2013/08/02/harddisk_structure_indepth/)
[硬盘概念：扇区，磁道，磁头，柱面，簇](https://blog.csdn.net/xiaominthere/article/details/19756551)
[Linux 引导过程内幕 666](https://www.ibm.com/developerworks/cn/linux/l-linuxboot/index.html)
[BIOS 传统模式下的 X86 PC 启动过程](https://woshijpf.github.io/内核/2017/06/26/Linux-内核加载启动过程分析.html)
[Basics of the Linux Boot Process 666 主要讲登录runlevel这里开始](https://www.youtube.com/watch?v=yeMA7AJFtb8)
[Linux Boot Sequence](https://www.youtube.com/watch?v=ALzySqflHJw)
[Linux 开机引导和启动过程详解 6666](https://linux.cn/article-8807-1.html)
[1-17-1-centos6系统启动过程及相关配置文件](https://www.bilibili.com/video/av31103819?from=search&seid=2837347037391725062)
