---
title: 理解计算机-文件系统
date: 2020-02-14 20:51:54
tags:
- 文件系统
categories:
- os教程
comments: false
permalink:
---

# 理解计算机-文件系统

操作系统提取处理器的概念来建立进程的抽象, 提取物理存储器的概念来建立进程地址空间的抽象.文件也是

文件时进程创建的信息逻辑单元. 操作系统中处理文件的部分称为文件系统.

文件命名, 不同的 os 有不同的命名规则

FAT-16 FAT-32 NTFS ReFS exFAT

文件扩展名, 用点隔开, 有些只是约定, 不强制用

文件结构: 常见的 3 种: 字节构造, 记录构造, 数

![s1.png](s1.png)

字节灵活
记录是固定长度, 读操作返回一个记录, 写操作重写或追加一个记录. 例如以前的 80 列读入, 132 列打出(80+52 空列)

**文件类型**: 常见的是普通文件和目录,unix 还有字符特殊文件和块特殊文件

普通文件时包含有用户信息的文件.
目录是管理文件系统结构的系统文件
字符特殊文件和输入/输出有关,用于串行 I/O 设备,如终端,打印机,网络等
块特殊文件用于磁盘类设备

普通文件一般分为 ASCII 文件和二进制文件.
ASCII 文件有多行正文组成. 有回车符, 换行符,或者同时用回车符和换行符作为一行结束.最大优势就是可以显示和打印, 还能用任何文本编辑器进行编辑.
二进制文件有一定内部结构, 直接打印无法理解, 要用该文件的程序才能了解这种结构.

文件访问
早期 os 只有一种文件访问方式: 顺序访问, 早期存储介质是磁带而不是磁盘时,
后面用随机访问, 磁盘上存储.两种方式可以指示从何处开始读取文件.一种是每次 read 操作都给出开始读文件的位置.另一种是用一个特殊的 seek 操作设置当前位置. unix 用这个.

文件属性
文件都有文件名和数据, 此外 OS 还会保存其他和文件相关的信息, 成为文件属性 attribute 或元数据 metadata

文件操作

- create: 创建不包含任何数据的文件. 表明文件即将建立, 并设置文件的一些属性.
- delete: 不需要文件时删除并释放磁盘空间.
- open: 使用文件之前要打开.把文件属性和磁盘地址表装入内存,便于后续调用快速访问.
- close: 访问结束后, 不在需要文件属性和磁盘地址, 要关闭文件以释放内部表空间.
- read: 在文件中读取数据.
- write: 向文件写数据.
- append: 是 write 的限制形式, 只能在文件末尾添加数据.
- seek: 用于随机访问文件, 要指定从何处开始获取数据.
- get attributes: 进程运行常需要读取文件属性
- set attributes
- rename: 改名

目录

文件系统通常提供 **目录** 或 **文件夹** 用于记录文件的位置. 很多系统中目录本身也是文件.

一级目录系统, 根目录.例如嵌入式这种简单的设备中.
层次目录系统.用目录树组织文件系统时,需要有某种方法指明文件名. 绝对路径名和相对路径名
每个进程都有自己的工作目录

支持层次目录结构的大多数 os 在每个目录中都有两个很特殊的目录项 `.`和`..`, `dot`和`dotdot`, 一个是当前目录, 一个是当前目录的父目录(根目录除外, 还是他自己) 所以才有 `cd ..`
`cp /usr .` 这个 dot 和 dotdot 也是常用的

目录操作

- create: 创建目录, 除了 `.` 和 `..` 目录内容为空. 通过`mkdir` 完成
- delete: 删除, 只有空目录才能删, 只包含 `.` 和 `..`
- opendir: 目录内容可被读取. 要列出目录中全部文件, 要先打开该目录, 然后读其中全部文件,
- closedir:读目录结束后, 关闭释放表空间.
- readdir:
- rename:
- link: 允许在多个目录中出现同一个文件
- unlink:删除.

文件系统实现
从用户到实现角度

文件系统布局
文件系统存放在磁盘上. 多数磁盘划分为一个或多个分区, 每个分区中有一个独立的文件系统.
磁盘的 0 号扇区成为主引导记录(MBR Mater Boot Record), 用来引导计算机. MBR 结尾是分区表.
计算机被引导时, BIOS 读入并执行 MNR.MBR 第一件事就是确定活动分区,读入它的第一块, 成为引导块(boot block)并执行. 引导块中的程序将装载该分区中的 OS,为了统一, 每个分区都从一个一个引导块开始.

> 当然除了从引导块开始外, 磁盘分区的布局是随着文件系统的不同而变化的. 超级快(superblock)

文件的实现.
文件存储实现的关键问题是记录各个文件分别用到哪些磁盘块

连续分配: 只要记得第一块的磁盘地址和文件的块数. 所以读也快, 只要一次寻找就行.不用寻道和旋转延迟.. 但随时间会有碎片
但在 DVD 中还是用连续的
链表分配:

采用内存中的表进行分配. 用文件分配表(FAT File Allocation Table), 比直接用链表块, 不用从一个一个物理块找过去. 而是读出一个块, 然后这个块内找
缺点就是必须把整个表都存放在内存中.对于 1TB 的磁盘和 1KB 大小的块, 这张表要有 10 亿项, 每一项对应于 10 亿个磁盘块中的一个快. 每项至少 3 字节, 有时候为了提高查询速度,需要 4KB. 这张表要 3GB 或 2.4GB. 所以这个方法并不实用.

> 格式化按一个个块
> 4KB 对齐

最后一个记录各个文件分别包含哪些磁盘块的方法是给每个文件都赋予一个称为 `i节点` 的数据结构(index-node).文件属性和文件块的磁盘地址.
优势: 只有在对应文件打开时, i 节点才在内存中. 比 FAT 所占据的空间小.
保留所有磁盘块的链表的表大小正比于磁盘自身的大小.如果磁盘有 n 块, 该表需要 n 个表项. 由于磁盘变得很大,该表格也随之线性增加.
相反,i 节点机制需要在内存中有一个数组,其大小正比于可能要同时打开的最大文件个数. 与磁盘容量无关.
但如果每个 i 节点只能存储固定数量的磁盘地址, 那么当一个文件所含的磁盘块的数目超出了 i 节点所能容纳的数目怎么办?可以将最后一个磁盘地址指向一个包含额外磁盘地址的块的地址

> 更高级的是: 可以有两个或更多个包含磁盘地址的块

目录的实现

读文件前需要打开文件, 打开文件时, OS 要利用用户给出的路径名找到对应的目录项.
目录系统的主要功能是把 ASCII 文件名映射成定位文件数据所需要的信息.
何处存放文件属性.可以直接存放在目录项中.
对于 i 节点的系统, 可以把文件属性存放在 i 节点中而不是目录项中.这样目录项会更短: 只有文件名和 i 节点号. 这种做法更好

目前为止都假设文件具有较短的,固定长度的名字. 但现在 OS 都支持可变长度的文件名.
最简单的就是给予一个长度限制,典型 255 个 字符. 但为每个文件名都保留 255 个字符空间,浪费了大量的目录空间.
可以放弃"所有目录项大小一样"的想法. 但也会有长度可变的空隙问题.

## UNIX V7 文件系统

文件系统从根目录开始形成树状, 加上链接, 形成了一个有向无环图. 文件名可以多达14B,能够容纳除了 `/` 和 `NUL`之外的任何ASCII字符.
unix目录中为每个文件保留了一项. 一个目录项包含了两个域: i节点编号(2B)和文件名(14B)

UNIX的i节点包含一些属性,包括文件大小,三个时间,所有者,所在组, 保护信息以及一个计数(链接用)
也有间接块

要打开文件时, 文件系统必须要有获得文件名并且定位他所在的磁盘块.
对一个路径 "/usr/ast/mbox"(绝对路径和相对路径都一样)
首先,文件系统定位根目录.在UNIX系统中, 根目录的i节点存放在磁盘上固定的位置.从这个i节点(一般inode是2), 系统将可以定位根目录., 虽然根目录可以存放在磁盘上的任何位置,但假定他放在磁盘块1的位置.
接下来, 系统读根目录并且在根目录中查找路径的第一个分量usr, 以获取/usr目录的i节点号. 根据这个i节点,系统定位到/usr目录并在其中查找下一个分量ast

![mbox.png](mbox.png)

CD-ROM的文件系统

> 可以先看下CD的物理结构

ISO 9660文件系统
目标就是使CD-ROM独立于机器所采用的的字节顺序和使用的OS,即在所有的机器上都是可读的.

CD-ROM没有和磁盘一样的同心柱面,而是沿一个连续的螺旋线来顺序存储信息.螺旋上的位序列被划分为大小为2352字节的逻辑块(也叫逻辑扇区),有些是用来引导,有些是用来进行纠错或其他一些用途. 每个逻辑块的有效部分是2048字节. 通常逻辑块按分钟或者秒来进行分配的. 通常转换系数1秒=75块, 这样就可以得到线性转换

## VFS 虚拟文件系统

是Linux内核的一个软件层, 实现对文件系统的抽象.

![VFS.png](VFS.png)

- 超级快(super block): 用于存储文件系统的控制信息的数据结构, 描述文件系统的状态,文件系统类型, 大小, 区块数, 索引节点数等, 存放于磁盘的特定扇区中.
- 索引节点(inode): 用于存储文件的元数据的一个数据结构, 包含诸如文件的大小,拥有者,创建时间, 磁盘位置等信息.128字节或256字节.
- 目录项(dentry): 目录被用来容纳文件, 目录可以包含子目录, 层层嵌套以形成文件路径
- 文件对象(file): 一组在逻辑上具有完整意义的信息项的系列.

每个文件除了有一个索引节点inode数据结构外,还有一个目录项dentry数据结构
dentry结构代表的是逻辑意义上的文件, 描述的是文件逻辑上的属性,目录项对象在磁盘上并没有对应的映像.
inode结构代表的是物理意义上的文件, 记录的是物理上的属性, 对于一个具体的文件系统, 其inode结构在磁盘上就有对应的映像
一个索引节点对象可能对应多个目录项对象.

进程通过文件描述符来访问文件的.

- 超级块是对一个文件系统的描述
- 索引节点是对一个文件物理属性的描述
- 目录项是对一个文件逻辑属性的描述
- 一个进程所处的位置是由fs_struct来描述的, 而一个进程(或用户)打开的文件时由files_struct来描述的, 而整个系统所打开的文件是由file结构来描述.

![vfs2.png](vfs2.png)

## 参考

{% post_link 解计算机-硬盘 解计算机-硬盘 %}
