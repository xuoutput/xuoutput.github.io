---
title: CDN原理
date: 2018-12-26 20:09:45
tags:
- CDN
categories:
- 网络
comments: false
permalink:
---

# CDN原理

传统的网站访问过程为:

* 用户在浏览器中输入要访问的域名;
* 浏览器向域名解析服务器发出解析请求，获得此域名对应的IP 地址;
* 浏览器利用所得到的IP 地址，向该IP对应的服务器发出访问请求;
* 服务器对此响应，将数据回传至用户浏览器端显示出来。

![dns.jpg](DNS.jpg)
![dns2.jpg](DNS2.jpeg)

与传统访问方式不同，CDN 网络则是在用户和服务器之间**增加 `Cache` 层**，将用户的访问请求引导到 `Cache` 节点而不是服务器源站点，要实现这一目的，主要是通过**接管DNS** 实现。

使用CDN 缓存后的网站访问过程演变为：

![CDN.jpg](CDN.jpg)

1. 用户在浏览器中输入要访问的域名;
2. 浏览器向域名解析服务器发出解析请求，由于CDN 对域名解析过程进行了调整，所以用户端一般得到的是该域名对应的 **CNAME 记录**，此时浏览器需要再次对获得的 `CNAME` 域名进行解析才能得到缓存服务器实际的IP 地址。(这里有2次)
   1. **注**：在此过程中 得到`CNAME`后,指向的是**全局负载均衡DNS解析服务器**(第二次解析得到这个服务器IP地址)，然后全局负载均衡DNS 解析服务器会根据用户端的源IP 地址，如地理位置(北京还是上海)、接入网类型(电信还是网通)将用户的访问请求定位到离用户路由最短、位置最近、负载最轻的Cache 节点(缓存服务器)上，实现就近定位。定位优先原则可按位置、可按路由、也可按负载等。这种技术也被称为**DNS 重定向**
3. 再次解析后浏览器得到该域名CDN 缓存服务器的实际IP 地址，向缓存服务器发出访问请求;
4. 缓存服务器根据浏览器提供的域名，通过Cache 内部专用DNS 解析得到此域名源服务器的真实IP 地址，再由缓存服务器向此真实IP 地址提交访问请求;
5. 缓存服务器从真实IP 地址得到内容后，一方面在本地进行保存，以备以后使用，另一方面把得到的数据发送到客户端浏览器，完成访问的响应过程;
6. 用户端得到由缓存服务器传回的数据后显示出来，至此完成整个域名访问过程。

通过以上分析可以看到，不论是否使用CDN 网络，普通用户客户端设置不需做任何改变，直接使用被加速网站原有域名访问即可。对于要加速的网站，只需修改整个访问过程中的域名解析部分，便能实现透明的网络加速服务。

![CDN2.jpg](CDN2.jpeg)

CDN客户使用CDN的方法：
对于CDN客户来说，不需要改动网站架构，只需要修改自己的DNS解析，设置一个CNAME指向CDN服务商即可。原理在下面会解释

通过上图，我们可以了解到，使用了CDN缓存后的网站的访问过程变为：

* 用户向浏览器提供要访问的域名；
* 浏览器调用域名解析库对域名进行解析，由于CDN对域名解析过程进行了调整，所以解析函数库得到的是该域名对应的CNAME记录（由于现在已经是使用了CDN服务，CNAME为CDN服务商域名），为了得到实际IP地址，浏览器需要再次对获得的CNAME域名进行解析以得到实际的IP地址；在此过程中，使用的全局负载均衡DNS解析，如根据地理位置信息解析对应的IP地址，使得用户能就近访问。（CDN服务来提供最近的机器）
* 此次解析得到CDN缓存服务器的IP地址，浏览器在得到实际的IP地址以后，向缓存服务器发出访问请求；
* 缓存服务器根据浏览器提供的要访问的域名，通过Cache内部专用DNS解析得到此域名的实际IP地址，再由缓存服务器向此实际IP地址提交访问请求；
* 缓存服务器从实际IP地址得得到内容以后，一方面在本地进行保存，以备以后使用，二方面把获取的数据返回给客户端，完成数据服务过程；
* 客户端得到由缓存服务器返回的数据以后显示出来并完成整个浏览的数据请求过程。

## 参考

[CDN加速原理](https://zhuanlan.zhihu.com/p/44966787)
[深度剖析：CDN内容分发网络技术原理](https://my.oschina.net/pooz/blog/95654)
[CDN的基本原理和基础架构](https://yq.aliyun.com/articles/104041)
[CDN工作原理](https://segmentfault.com/a/1190000000538796)