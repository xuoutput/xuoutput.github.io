---
title: ä½¿ç”¨Promise
date: 2018-11-21 10:02:01
tags:
- es6
- promise
categories:
- javascriptæ•™ç¨‹
comments: false
permalink:
---

# Promise æ˜¯ä»€ä¹ˆ,ä½¿ç”¨ Promise

å…ˆçœ‹ `async` å’Œ `await` å§,ç„¶åæ··å…¥ `promise`

**ä»`Promise`å¯¹è±¡çš„æ–¹æ³•å’ŒåŸå‹çš„æ–¹æ³•ä¸Šçš„è¿”å›å’Œä¼ å…¥å‚æ•°çœ‹**

## Promise æ˜¯ä»€ä¹ˆ, ä¸»è¦ä»‹ç» Promise æ„é€ å‡½æ•°

**Promise** å¯¹è±¡ç”¨äºè¡¨ç¤ºä¸€ä¸ª`å¼‚æ­¥æ“ä½œ`çš„æœ€ç»ˆ`çŠ¶æ€`ï¼ˆå®Œæˆæˆ–å¤±è´¥ï¼‰ï¼Œä»¥åŠå…¶`è¿”å›çš„å€¼`ã€‚

å…·ä½“æè¿°çœ‹ä¸‹é¢

> ä¸‹é¢ä¸»è¦å†…å®¹æ˜¯ `Promise` æ„é€ å‡½æ•°, æ„é€ å‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥åŒ…è£…è¿˜æœªæ”¯æŒ `promise` çš„å‡½æ•°
> æ‰€ä»¥è¦ `new` ä¸€ä¸ª

```javascript
var promise1 = new Promise(function(resolve, reject) {
  setTimeout(function() {
    resolve('foo');
  }, 300);
});

promise1.then(function(value) {
  console.log(value);
  // expected output: "foo"
});

console.log(promise1);
// expected output: [object Promise]
```

## åˆ›å»º Promise

`Promise`å¯¹è±¡æ˜¯ç”±å…³é”®å­— `new` åŠå…¶`æ„é€ å‡½æ•°`æ¥åˆ›å»ºçš„ã€‚è¯¥æ„é€ å‡½æ•°ä¼šæŠŠä¸€ä¸ªå«åšâ€œå¤„ç†å™¨å‡½æ•°â€ï¼ˆ`executor function`ï¼‰çš„å‡½æ•°ä½œä¸ºå®ƒçš„`å‚æ•°`ã€‚è¿™ä¸ªâ€œå¤„ç†å™¨å‡½æ•°â€æ¥å—`ä¸¤ä¸ªå‡½æ•°`â€”â€”`resolve` å’Œ `reject` â€”â€”ä½œä¸ºå…¶å‚æ•°ã€‚å½“å¼‚æ­¥ä»»åŠ¡é¡ºåˆ©å®Œæˆä¸”è¿”å›ç»“æœå€¼æ—¶(å¼‚æ­¥æ“ä½œåœ¨`executor`å†…)ï¼Œä¼šè°ƒç”¨ `resolve` å‡½æ•°ï¼›è€Œå½“å¼‚æ­¥ä»»åŠ¡å¤±è´¥ä¸”è¿”å›å¤±è´¥åŸå› ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼‰æ—¶ï¼Œä¼šè°ƒç”¨`reject` å‡½æ•°ã€‚

> é«˜é˜¶å‡½æ•°, å¯ä»¥æŠŠå‡½æ•°ä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å‡½æ•° {% post_link javascript-é«˜é˜¶å‡½æ•° javascript-é«˜é˜¶å‡½æ•° %}

## è¯­æ³•

```javascript
new Promise( function(resolve, reject) {...} /* executor */  );
```

å‚æ•°å°±æ˜¯ä¸€ä¸ª `function(resolve, reject) {...}` è¿™ä¸ª`executor`

> !**æ³¨æ„, è¿™ä¸ª `executor` ä¸æ˜¯ç”¨ `return`, è€Œæ˜¯è¿”å›å¹¶æ‰§è¡Œ `resolve, reject` å›è°ƒå‡½æ•°**
> !**æ³¨æ„, è¿™ä¸ª `executor` ä¸æ˜¯ç”¨ `return`, è€Œæ˜¯è¿”å›å¹¶æ‰§è¡Œ `resolve, reject` å›è°ƒå‡½æ•°**
> !**æ³¨æ„, è¿™ä¸ª `executor` ä¸æ˜¯ç”¨ `return`, è€Œæ˜¯è¿”å›å¹¶æ‰§è¡Œ `resolve, reject` å›è°ƒå‡½æ•°**

`executor`æ˜¯å¸¦æœ‰ `resolve` å’Œ `reject` ä¸¤ä¸ªå‚æ•°çš„**å‡½æ•°** ã€‚**è¿™ä¸¤ä¸ªå‚æ•°ä¹Ÿæ˜¯å‡½æ•°**. (**å›è°ƒå‡½æ•°å“¦**)

**Promise**æ„é€ å‡½æ•°æ‰§è¡Œæ—¶ç«‹å³è°ƒç”¨ `executor` å‡½æ•°ï¼ˆ **executor å‡½æ•°åœ¨ Promise æ„é€ å‡½æ•°è¿”å›æ–°å»ºå¯¹è±¡å‰è¢«è°ƒç”¨**ï¼‰ï¼Œ `resolve` å’Œ `reject` ä¸¤ä¸ª**å‡½æ•°**ä½œä¸ºå‚æ•°ä¼ é€’ç»™ `executor`ã€‚`executor å†…éƒ¨`é€šå¸¸ä¼šæ‰§è¡Œä¸€äº›**å¼‚æ­¥æ“ä½œ**ï¼Œ
ä¸€æ—¦å®Œæˆï¼Œå¯ä»¥è°ƒç”¨ `resolve` å‡½æ•°æ¥å°† `promise` çŠ¶æ€æ”¹æˆ `fulfilled`ï¼Œæˆ–è€…åœ¨å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨`reject`å‡½æ•°å°†å®ƒçš„çŠ¶æ€æ”¹ä¸º `rejected`ã€‚ ä»è¿™é‡ŒçŸ¥é“, **Promise çš„çŠ¶æ€æ˜¯é€šè¿‡å›è°ƒå‡½æ•°`resolve`å’Œ`reject`æ”¹çš„**

å³:`resolve` å’Œ `reject` å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œåˆ†åˆ«å°† `promise` çš„çŠ¶æ€æ”¹ä¸º `fulfilled`ï¼ˆå®Œæˆï¼‰æˆ– `rejected`ï¼ˆå¤±è´¥ï¼‰ã€‚

å¦‚æœåœ¨ `executor` å‡½æ•°ä¸­æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆè¯¥ `promise` çŠ¶æ€ä¸º `rejected` ã€‚ `executor` å‡½æ•°çš„è¿”å›å€¼è¢«å¿½ç•¥ã€‚

> `resolve` å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°† `Promise` å¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œæˆåŠŸâ€ï¼ˆå³ä» `pending` å˜ä¸º `resolved`ï¼‰ï¼Œåœ¨å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ï¼›
> `reject` å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°† `Promise` å¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œå¤±è´¥â€ï¼ˆå³ä» `pending` å˜ä¸º `rejected`ï¼‰ï¼Œ åœ¨å¼‚æ­¥æ“ä½œå¤±è´¥æ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œæŠ¥å‡ºçš„é”™è¯¯ï¼Œä½œä¸ºå‚æ•°ä¼ é€’å‡ºå»ã€‚

## æè¿°

`Promise` å¯¹è±¡æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆ**ä»£ç†ä¸€ä¸ªå€¼**ï¼‰ï¼Œè¢«ä»£ç†çš„**å€¼**åœ¨ `Promise` å¯¹è±¡**åˆ›å»ºæ—¶å¯èƒ½æ˜¯æœªçŸ¥çš„**(æ¯”å¦‚å¯ä»¥æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œ,ä¹Ÿå¯ä»¥ç›´æ¥æ˜¯ä¸€ä¸ªç¡®å®šçš„å€¼, æ€»ä¹‹éƒ½ç”¨ Promise åŒ…èµ·æ¥)ã€‚

å®ƒ**å…è®¸ä½ ä¸ºå¼‚æ­¥æ“ä½œçš„æˆåŠŸå’Œå¤±è´¥åˆ†åˆ«ç»‘å®šç›¸åº”çš„å¤„ç†æ–¹æ³•**ï¼ˆhandlersï¼‰ã€‚ è¿™è®©å¼‚æ­¥æ–¹æ³•å¯ä»¥**åƒåŒæ­¥æ–¹æ³•**é‚£æ ·è¿”å›å€¼ï¼Œä½†**å¹¶ä¸æ˜¯ç«‹å³è¿”å›**æœ€ç»ˆæ‰§è¡Œç»“æœï¼Œè€Œæ˜¯ä¸€ä¸ªèƒ½**ä»£è¡¨æœªæ¥å‡ºç°çš„ç»“æœ**çš„ `promise` å¯¹è±¡

ä¸€ä¸ª `Promise` æœ‰ä»¥ä¸‹ 3 ç§çŠ¶æ€: **Promise çš„çŠ¶æ€æ˜¯é€šè¿‡å›è°ƒå‡½æ•°`resolve`å’Œ`reject`æ”¹çš„**

- `pending`: åˆå§‹çŠ¶æ€ï¼Œæ—¢ä¸æ˜¯æˆåŠŸï¼Œä¹Ÿä¸æ˜¯å¤±è´¥çŠ¶æ€ã€‚
- `fulfilled`: æ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚å¯¹åº”ä»è°ƒç”¨`resolve`å‡½æ•°
- `rejected`: æ„å‘³ç€æ“ä½œå¤±è´¥ã€‚ å¯¹åº”ä»è°ƒç”¨`reject`å‡½æ•°

> æ³¨æ„ï¼š å¦‚æœä¸€ä¸ª promise å¯¹è±¡å¤„åœ¨ fulfilled æˆ– rejected çŠ¶æ€è€Œä¸æ˜¯ pending çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå¯ä»¥è¢«ç§°ä¸º`settled`çŠ¶æ€ã€‚

`pending` çŠ¶æ€çš„ `Promise` å¯¹è±¡å¯èƒ½è§¦å‘ `fulfilled` çŠ¶æ€å¹¶ä¼ é€’ä¸€ä¸ªå€¼ç»™ç›¸åº”çš„çŠ¶æ€å¤„ç†æ–¹æ³• `resolve` ï¼Œä¹Ÿå¯èƒ½è§¦å‘å¤±è´¥çŠ¶æ€ï¼ˆ`rejected`ï¼‰å¹¶ä¼ é€’å¤±è´¥ä¿¡æ¯ç»™ `reject`æ–¹æ³• ã€‚

> ä»è¿™é‡Œçœ‹å‡º, å…ˆæ˜¯æ‰§è¡Œç¬¬ä¸€ä¸ª`Promise`å¯¹è±¡,ç„¶åè§¦å‘å›è°ƒçš„æ–¹æ³•`resolve` `reject`, äº§ç”Ÿä¸€ä¸ªæ–°çš„`Promise`å¯¹è±¡.
> ç„¶å ğŸ‘‡ ä¸‹é¢æ˜¯`Promise`å¯¹è±¡åŸå‹ä¸Šçš„æ–¹æ³•æ¥å¤„ç†(å°±ä¼šè¢«è§¦å‘è°ƒç”¨),ç”¨åˆ°`then` `catch`

å½“å…¶ä¸­ä»»ä¸€ç§æƒ…å†µå‡ºç°æ—¶ï¼Œ`Promise` å¯¹è±¡çš„ `then` æ–¹æ³•(**è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ Promise çš„åŸå‹ä¸Šçš„, å¹¶è¿”å›ä¸€ä¸ª Promise å¯¹è±¡**)ç»‘å®šçš„å¤„ç†æ–¹æ³•ï¼ˆhandlers ï¼‰å°±ä¼š**è¢«è°ƒç”¨**
ï¼ˆ `then` æ–¹æ³•åŒ…å«**ä¸¤ä¸ªå‚æ•°,ä¹Ÿéƒ½æ˜¯å‡½æ•°**ï¼š`onfulfilled` å’Œ `onrejected`ï¼Œå®ƒä»¬éƒ½æ˜¯ `Function` ç±»å‹ã€‚å½“ `Promise` çŠ¶æ€ä¸º `fulfilled` æ—¶ï¼Œè°ƒç”¨ `then` çš„ `onfulfilled` æ–¹æ³•ï¼Œå½“ `Promise` çŠ¶æ€ä¸º `rejected` æ—¶ï¼Œè°ƒç”¨ `then` çš„ `onrejected` æ–¹æ³•ï¼Œ æ‰€ä»¥åœ¨å¼‚æ­¥æ“ä½œçš„å®Œæˆå’Œç»‘å®šå¤„ç†æ–¹æ³•ä¹‹é—´ä¸å­˜åœ¨ç«äº‰ï¼‰ã€‚

> è¿™é‡Œææ‡‚, ç¬¬ä¸€ä¸ª`Promise`é€šè¿‡æ‰§è¡Œ`executor`çš„å›è°ƒå‡½æ•°`resolve` `reject`å˜ä¸ºç›¸åº”çš„`fulfilled`æˆ–`rejected`çŠ¶æ€, è¿”å›ä¸€ä¸ª`æ–°çš„Promise`å¯¹è±¡.
> ç„¶å`then`æ–¹æ³•æ ¹æ®è¿”å›çš„`æ–°çš„Promise`å¯¹è±¡çš„**çŠ¶æ€**, è°ƒç”¨ç›¸åº”çš„`onfulfilled`æˆ–`onrejected`æ–¹æ³•.

æ‰€ä»¥çŠ¶æ€æ˜¯ 3 ç§, Promise çš„å›è°ƒå‡½æ•° 2 ç§, then æ–¹æ³•çš„å›è°ƒä¹Ÿæ˜¯ 2 ç§

`pending` `fulfilled` `rejected`
`resolve` `reject`
`onfulfilled` `onrejected`

å¹³æ—¶è§åˆ°çš„ `then`å’Œ `catch` å¯ä»¥**é“¾å¼è°ƒç”¨**çš„åŸå› æ˜¯å› ä¸º `Promise.prototype.then` å’Œ `Promise.prototype.catch` æ–¹æ³•è¿”å› `promise` å¯¹è±¡

> **æ³¨æ„**: `then`æ–¹æ³•æ˜¯åœ¨ `Promise`å¯¹è±¡çš„åŸå‹ä¸Š`prototype`çš„, `Promise`å¯¹è±¡æœ¬èº«å°± 4 ä¸ªæ–¹æ³•`resolve` `reject` `all` `race`
> åŸå‹ä¸Š 3 ä¸ª `then` `catch` `finally`

![2.png](2.png)

## å±æ€§å’Œæ–¹æ³•(ä¸Šé¢æ¶‰åŠäº† Promise çš„æ–¹æ³•å’Œ Promise åŸå‹ä¸Šçš„æ–¹æ³•, å…·ä½“ä»‹ç»ä¸‹)

çœ‹å®Œæ–¹æ³•å’ŒåŸå‹çš„è¿”å›, åœ¨å›é¡¾å»çœ‹ä¸‹æè¿°å°±æ›´å¥½

### å±æ€§ ä¸å¸¸ç”¨ 2 ä¸ª

`Promise.length` length å±æ€§ï¼Œå…¶å€¼æ€»æ˜¯ä¸º 1 (æ„é€ å™¨å‚æ•°çš„æ•°ç›®).

`Promise.prototype` è¡¨ç¤º Promise æ„é€ å™¨çš„åŸå‹.

### æ–¹æ³•å’ŒåŸå‹

`Promise`çš„æ–¹æ³• 4 ä¸ª, éƒ½è¿”å›`Promise`å¯¹è±¡

1. `Promise.resolve(value)`: è¿”å›ä¸€ä¸ªçŠ¶æ€ç”±ç»™å®š`value`å†³å®šçš„`Promiseå¯¹è±¡`ã€‚
   å¦‚æœè¯¥`value`æ˜¯ä¸€ä¸ª`Promise`å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›è¯¥`Promise`å¯¹è±¡ï¼›
   å¦‚æœè¯¥å€¼æ˜¯`thenable`(å³ï¼Œå¸¦æœ‰`then`æ–¹æ³•çš„å¯¹è±¡)ï¼Œè¿”å›çš„`Promise`å¯¹è±¡çš„æœ€ç»ˆçŠ¶æ€ç”±`then`æ–¹æ³•æ‰§è¡Œå†³å®šï¼›(**æ³¨æ„**: åº”è¯¥æ˜¯`Promise.resolve`æ–¹æ³•ä¼šå°†è¿™ä¸ªå¯¹è±¡è½¬ä¸º `Promise` å¯¹è±¡ï¼Œç„¶åå°±ç«‹å³æ‰§è¡Œ`thenable`å¯¹è±¡çš„`then`æ–¹æ³•ã€‚)

```javascript
// è¿™æ˜¯ä¸€ä¸ªæ»´å•Šæœ‰thenæ–¹æ³•çš„å¯¹è±¡, æ‰€ä»¥
let thenable = {
  then: function(resolve, reject) {
    resolve(42);
  }
};

let p1 = Promise.resolve(thenable); // è¿™é‡Œå…ˆåŒ…è£…thenable
p1.then(function(value) {
  // è¿™é‡Œæ‰§è¡Œ, æœ€ç»ˆç»“æœ.
  console.log(value); // 42
});
```

å¦åˆ™çš„è¯(è¯¥`value`ä¸º`ç©º`ï¼Œ`åŸºæœ¬ç±»å‹`æˆ–è€…ä¸å¸¦`then`æ–¹æ³•çš„å¯¹è±¡),è¿”å›çš„`Promise`å¯¹è±¡çŠ¶æ€ä¸º`fulfilled`ï¼Œå¹¶ä¸”å°†è¯¥`value`ä¼ é€’ç»™å¯¹åº”çš„`then`æ–¹æ³•ã€‚
**é€šå¸¸è€Œè¨€**ï¼Œå¦‚æœä½ ä¸çŸ¥é“ä¸€ä¸ªå€¼æ˜¯å¦æ˜¯`Promise`å¯¹è±¡ï¼Œä½¿ç”¨`Promise.resolve(value)` æ¥è¿”å›ä¸€ä¸ª`Promise`å¯¹è±¡,è¿™æ ·å°±èƒ½å°†è¯¥`value`ä»¥`Promise`å¯¹è±¡å½¢å¼ä½¿ç”¨ã€‚

2. `Promise.reject(reason)`: è¿”å›ä¸€ä¸ªçŠ¶æ€ä¸ºå¤±è´¥çš„`Promiseå¯¹è±¡`ï¼Œå¹¶å°†ç»™å®šçš„å¤±è´¥ä¿¡æ¯`reason`ä¼ é€’ç»™å¯¹åº”çš„å¤„ç†æ–¹æ³•`catch`ä½.(å®é™…ä¸Šåªæ˜¯ `then(null, ...)` çš„è¯­æ³•ç³–)
3. `Promise.all(iterable)`: è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„`promise`å¯¹è±¡(**æˆåŠŸå¯¹åº”è¿”å› resolve ä¸€ä¸ª Promise åŒ…è£…çš„æ‰€æœ‰æˆåŠŸ value çš„æ•°ç»„, å¤±è´¥å°±è¿”å› reject ç¬¬ä¸€ä¸ªå¤±è´¥çš„é‚£ä¸ªçš„ reason ä¿¡æ¯**)ï¼Œè¯¥`promise`å¯¹è±¡åœ¨`iterable`å‚æ•°å¯¹è±¡é‡Œ(ä¸æ˜¯è¯´æ˜¯`æ•°ç»„`,è€Œæ˜¯è¯´è¦å…·æœ‰`iterable`æ¥å£)`æ‰€æœ‰çš„promise`å¯¹è±¡éƒ½æˆåŠŸçš„æ—¶å€™æ‰ä¼šè§¦å‘æˆåŠŸï¼Œä¸€æ—¦æœ‰ä»»ä½•ä¸€ä¸ª`iterable`é‡Œé¢çš„`promise`å¯¹è±¡`å¤±è´¥`åˆ™ç«‹å³è§¦å‘è¯¥`promise`å¯¹è±¡çš„å¤±è´¥ã€‚
   > è¿™ä¸ª`æ–°çš„promise`å¯¹è±¡åœ¨è§¦å‘æˆåŠŸçŠ¶æ€ä»¥åï¼Œä¼šæŠŠä¸€ä¸ªåŒ…å«`iterable`é‡Œ`æ‰€æœ‰promise`è¿”å›å€¼çš„`æ•°ç»„`ä½œä¸ºæˆåŠŸå›è°ƒçš„è¿”å›å€¼ï¼Œé¡ºåºè·Ÿ`iterable`çš„é¡ºåºä¿æŒä¸€è‡´ï¼›å¦‚æœè¿™ä¸ªæ–°çš„`promise`å¯¹è±¡è§¦å‘äº†`å¤±è´¥çŠ¶æ€`ï¼Œå®ƒä¼šæŠŠ iterable é‡Œç¬¬ä¸€ä¸ªè§¦å‘å¤±è´¥çš„`promise`å¯¹è±¡çš„é”™è¯¯ä¿¡æ¯ä½œä¸ºå®ƒçš„å¤±è´¥é”™è¯¯ä¿¡æ¯ã€‚`Promise.all`æ–¹æ³•å¸¸è¢«ç”¨äºå¤„ç†`å¤šä¸ªpromise`å¯¹è±¡çš„çŠ¶æ€é›†åˆã€‚
4. `Promise.race(iterable)`: å½“`iterable`å‚æ•°é‡Œçš„ä»»æ„ä¸€ä¸ª`å­promise`è¢«æˆåŠŸæˆ–å¤±è´¥å(å°±æ˜¯çœ‹æœ€å¿«çš„é‚£ä¸ª, `all`ç›¸å½“äºæ˜¯çœ‹æœ€æ…¢çš„)ï¼Œ`çˆ¶promise`é©¬ä¸Šä¹Ÿä¼šç”¨`å­promise`çš„æˆåŠŸè¿”å›å€¼æˆ–å¤±è´¥è¯¦æƒ…ä½œä¸ºå‚æ•°è°ƒç”¨`çˆ¶promise`ç»‘å®šçš„ç›¸åº”å¥æŸ„ï¼Œå¹¶è¿”å›è¯¥`promise`å¯¹è±¡ã€‚(**æ³¨æ„**: `Promise.race` åœ¨ç¬¬ä¸€ä¸ª`promise`å¯¹è±¡å˜ä¸º`Fulfilled`ä¹‹åï¼Œå¹¶ä¸ä¼šå–æ¶ˆå…¶ä»–`promise`å¯¹è±¡çš„æ‰§è¡Œã€‚)

![3.png](3.png)

`Promise`åŸå‹, 1 ä¸ªå±æ€§, 3 ä¸ªæ–¹æ³•

å±æ€§å°±æ˜¯åŸå‹éƒ½æœ‰çš„`romise.prototype.constructor` è¿”å›è¢«åˆ›å»ºçš„å®ä¾‹å‡½æ•°. é»˜è®¤ä¸º `Promise å‡½æ•°`

æ–¹æ³•å°±æ˜¯å¸¸è§çš„ 3 ä¸ª, `then` `catch` `finally`

1. `Promise.prototype.then(onFulfilled, onRejected)`: æ·»åŠ è§£å†³(`fulfillment`)å’Œæ‹’ç»(`rejection`)å›è°ƒåˆ°å½“å‰ `promise`, è¿”å›ä¸€ä¸ª`æ–°çš„ promise`, å°†ä»¥å›è°ƒçš„è¿”å›å€¼æ¥`resolve`. (`catch`åªæ˜¯`then`çš„ä¸€ä¸ªç‰¹ä¾‹)

2. `Promise.prototype.catch(onRejected)`: æ·»åŠ ä¸€ä¸ªæ‹’ç»(`rejection`) å›è°ƒåˆ°å½“å‰ `promise`, è¿”å›ä¸€ä¸ª`æ–°çš„promise`ã€‚å½“è¿™ä¸ªå›è°ƒå‡½æ•°è¢«è°ƒç”¨ï¼Œ`æ–° promise` å°†ä»¥å®ƒçš„è¿”å›å€¼æ¥`resolve`ï¼Œå¦åˆ™å¦‚æœå½“å‰`promise` è¿›å…¥`fulfilled`çŠ¶æ€ï¼Œåˆ™ä»¥å½“å‰`promise`çš„å®Œæˆç»“æœä½œä¸ºæ–°`promise`çš„å®Œæˆç»“æœ.**æ³¨æ„è¿™ä¸ªä¹Ÿæ˜¯è¿”å›ä¸€ä¸ª Promise, å½“æˆ`then`åªæœ‰ç¬¬ 2 ä¸ªå‚æ•°æ—¶å‘—**

3. `Promise.prototype.finally(onFinally)`: æ·»åŠ ä¸€ä¸ªäº‹ä»¶å¤„ç†å›è°ƒäºå½“å‰`promise`å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨`åŸpromise`å¯¹è±¡è§£æå®Œæ¯•åï¼Œè¿”å›ä¸€ä¸ª`æ–°çš„promise`å¯¹è±¡ã€‚å›è°ƒä¼šåœ¨å½“å‰`promise`è¿è¡Œå®Œæ¯•åè¢«è°ƒç”¨ï¼Œæ— è®º`å½“å‰promise`çš„çŠ¶æ€æ˜¯å®Œæˆ(`fulfilled`)è¿˜æ˜¯å¤±è´¥(`rejected`)

![resolved.png](resolved.png)

å…³äº`Symbol(Symbol.toStringTag): "Promise"`çš„çŸ¥è¯†, çœ‹[Symbol.toStringTag](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Symbol/toStringTag)

## æ€»ç»“ : çœ‹[ä½ çœŸçš„å®Œå…¨æŒæ¡äº† promise ä¹ˆï¼Ÿ](https://juejin.im/post/5af29a62f265da0b8f628973)

**Promise** å¯¹è±¡ç”¨äºè¡¨ç¤ºä¸€ä¸ª`å¼‚æ­¥æ“ä½œ`çš„æœ€ç»ˆ`çŠ¶æ€`ï¼ˆå®Œæˆæˆ–å¤±è´¥ï¼‰ï¼Œä»¥åŠå…¶`è¿”å›çš„å€¼`ã€‚

`Promise`ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯å¦‚æœæ•°æ®å°±ç»ª(`settled`)ï¼Œé‚£ä¹ˆ(`then`)åšç‚¹ä»€ä¹ˆã€‚

`Promise`æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯`resolve`å’Œ`reject`ã€‚

```javascript
const promise = new Promise(function(resolve, reject) {
  // ... some code

  if (/* å¼‚æ­¥æ“ä½œæˆåŠŸ */){
    resolve(value);
  } else {
    reject(error);
  }
});
```

1. `resolve`å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°†`Promise`å¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œæˆåŠŸâ€ï¼ˆå³ä» `pending` å˜ä¸º`fulfilled`ï¼‰ï¼Œåœ¨å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œçš„ç»“æœï¼Œä½œä¸º`å‚æ•°`ä¼ é€’å‡ºå»ï¼›
2. `reject`å‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œå°†`Promise`å¯¹è±¡çš„çŠ¶æ€ä»â€œæœªå®Œæˆâ€å˜ä¸ºâ€œå¤±è´¥â€ï¼ˆå³ä» `pending` å˜ä¸º`rejected`ï¼‰ï¼Œ åœ¨å¼‚æ­¥æ“ä½œå¤±è´¥æ—¶è°ƒç”¨ï¼Œå¹¶å°†å¼‚æ­¥æ“ä½œæŠ¥å‡ºçš„é”™è¯¯ï¼Œä½œä¸º`å‚æ•°`ä¼ é€’å‡ºå»ã€‚

`Promise`å®ä¾‹ç”Ÿæˆä»¥åï¼Œå¯ä»¥ç”¨`then`æ–¹æ³•åˆ†åˆ«æŒ‡å®š`resolved`çŠ¶æ€å’Œ`rejected`çŠ¶æ€çš„`å›è°ƒå‡½æ•°`ã€‚

```javascript
promise.then(
  function(value) {
    // success
  },
  function(error) {
    // failure
  }
);
```

ç«‹å³`resolve`çš„ `Promise` å¯¹è±¡ï¼Œæ˜¯åœ¨**æœ¬è½®**â€œäº‹ä»¶å¾ªç¯â€ï¼ˆ`event loop`ï¼‰çš„ç»“æŸæ—¶ï¼Œè€Œä¸æ˜¯åœ¨ä¸‹ä¸€è½®â€œäº‹ä»¶å¾ªç¯â€çš„å¼€å§‹æ—¶ã€‚

```javascript
setTimeout(function() {
  console.log('three');
}, 0);

Promise.resolve().then(function() {
  console.log('two');
});

console.log('one');

// one
// two
// three
```

ä¸Šé¢ä»£ç ä¸­ï¼Œ`setTimeout(fn, 0)`åœ¨**ä¸‹ä¸€è½®**â€œäº‹ä»¶å¾ªç¯â€å¼€å§‹æ—¶æ‰§è¡Œï¼Œ`Promise. resolve()`åœ¨**æœ¬è½®**â€œäº‹ä»¶å¾ªç¯â€ç»“æŸæ—¶æ‰§è¡Œï¼Œ`console.log('one')`åˆ™æ˜¯**ç«‹å³æ‰§è¡Œ**ï¼Œå› æ­¤æœ€å…ˆè¾“å‡ºã€‚

**ç‰¹åˆ«è¯´æ˜**ï¼šå¦‚æœéœ€è¦`resolve()`å¾€åä¼ é€’**å¤šä¸ª**å‚æ•°ï¼Œä¸èƒ½ç›´æ¥å†™`resolve(a1,a2,a3)`ï¼Œè¿™æ ·åªèƒ½æ‹¿åˆ°ç¬¬ä¸€ä¸ªè¦ä¼ çš„å‚æ•°ï¼Œéœ€è¦ä»¥æ•°ç»„æˆ–å¯¹è±¡å»ä¼ é€’

```javascript
let obj = { a1: a1, a2: a2, a3: a3 };
resolve(obj);
//or
let arr = [a1, a2, a3];
resolve(arr);
```

Promise çš„é“¾è¿˜åœä¸äº†è¯¶

```javascript
// è¿™é‡Œæ˜¯è¿”å›ä¸€ä¸ªpendingçŠ¶æ€çš„Promise
new Promise(function() {});
```

è™½ç„¶ä¸Šé¢å¯ä»¥åœä½, ä½†ä¼šå¯¼è‡´å†…å­˜æ³„æ¼,æ¯•ç«Ÿä¸€ç›´åœä½äº†, ä¸é‡Šæ”¾å†…å­˜.

## è¡ç”Ÿ

[Understand promises before you start using async/await](https://medium.com/@bluepnume/learn-about-promises-before-you-start-using-async-await-eb148164a9c8) è¿™ä¸ªé“¾æ¥é‡Œé¢æœ‰ `callback` è½¬ `promsieçš„`

[Implementing](https://www.promisejs.org/implementing/) è¿™é‡Œæœ‰ä»å¤´è‡ªå·±å®ç°ä¸€ä¸ª `promise`çš„

## ajax å’Œ fetch

## å‚è€ƒ

[Promise](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)
[ä½¿ç”¨ Promises](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Using_promises)
[é˜®ä¸€å³° es6 Promise å¯¹è±¡](http://es6.ruanyifeng.com/?search=import&x=0&y=0#docs/promise)

è¿›é˜¶
[ä½ çœŸçš„å®Œå…¨æŒæ¡äº† promise ä¹ˆï¼Ÿ](https://juejin.im/post/5af29a62f265da0b8f628973)
[å¯¹ Promise çŠ¶æ€çš„ç†è§£å’ŒåŸºæœ¬ç”¨æ³•](https://juejin.im/post/5a58551ef265da3e51330a8e)
[ä»å¦‚ä½•åœæ‰ Promise é“¾è¯´èµ·](https://github.com/xieranmaya/blog/issues/5)
